# UI脆弱性・改善箇所レポート

作成日: 2026-02-15
対象: Webアプリケーション全体のUI/UX（コードベース静的解析に基づく）

本ドキュメントは、現在のコードベースにおいて「UIが崩れる」「操作不能になる」可能性が高い箇所を抽出し、改善案をまとめたものです。

## 🚨 重要度: 高 (Critical) - 操作不能や著しい表示崩れのリスク

### 1. モバイルブラウザでの `100vh` 問題（iOS Safari等）
- **現象**: `src/routes/[channel_id]/+page.svelte` や `sidebar.svelte` で `height: 100vh` が使用されています。iOS Safariなどではアドレスバーが表示されている間、`100vh` が画面の可視領域よりも大きくなり、**画面下部の入力エリアやボタンが隠れて押せなくなる**、あるいは**スクロールができない**状態になります。
- **影響**: モバイルユーザーがチャット入力や送信を行えない可能性があります。
- **推奨対策**: `100vh` の代わりに `100dvh` (Dynamic Viewport Height) を使用するか、JavaScriptで `window.innerHeight` を取得して `--vh` 変数としてセットする手法を採用してください。

### 2. Z-index の管理不全と競合
- **現象**: `z-index` の値が各コンポーネントで場当たり的に設定されており、体系化されていません。
    - サイドバー: `1000`
    - 画像モーダル: `1000`
    - 設定モーダル: `1500`
    - アップロードオーバーレイ: `10000`
    - 汎用モーダル: `1001`
- **影響**: サイドバーが開いている状態で画像をクリックした際、**画像モーダルがサイドバーの下に潜り込む**、あるいは**閉じるボタンが押せなくなる**などの重なり順序バグが発生するリスクがあります。
- **推奨対策**: `src/styles/style.scss` にZ-indexのレイヤー定数（変数）を定義し、全コンポーネントでそれを参照するように統一してください（例: `--z-sidebar: 100`, `--z-modal: 200`, `--z-toast: 300`）。

## ⚠️ 重要度: 中 (Major) - 特定条件下でのレイアウト崩れ

### 3. 長いコンテンツによるレイアウト破壊
- **現象**: `post.svelte` 内で `word-wrap: break-word` は設定されていますが、`word-break: break-all` が `.url-link` 以外に適用されていません。
- **影響**: URLではない非常に長い英数字の羅列（ハッシュ値、トークン、長いコードスニペットなど）が投稿された場合、**投稿コンテナを突き破って横スクロールが発生**し、レイアウト全体が崩れる可能性があります。
- **推奨対策**: 投稿本文のラッパーに対して `overflow-wrap: anywhere` または `word-break: break-word` を適用してください。

### 4. 画像ギャラリー・プレビューの表示崩れ
- **現象**:
    - `post.svelte`: 画像ギャラリーは横スクロールですが、極端に縦長の画像が混ざった場合の高さ制限が明確でなく、レイアウトが縦に間延びする可能性があります。
    - `[channel_id]/+page.svelte`: 入力エリアの画像プレビュー (`.image-preview-container`) は `flex-wrap` などの考慮が甘く、大量の画像を添付した際に**入力欄を圧迫して見えなくなる**可能性があります。
- **推奨対策**: 画像コンテナに `max-height` を設定し、`aspect-ratio` を活用してレイアウトシフトを防ぐこと、プレビューエリアのスクロール処理を強化することを推奨します。

### 5. モバイルキーボードによる入力エリア隠れ
- **現象**: `[channel_id]/+page.svelte` の入力エリアは `position: sticky; bottom: 0` ですが、Androidなどの一部ブラウザではキーボード出現時にビューポートの計算が変わり、**入力欄がキーボードの裏に隠れる**か、**極端に狭くなる**可能性があります。
- **推奨対策**: `interactive-widget` メタタグの設定確認や、Visual Viewport API を用いた位置調整の検討が必要です。

## ℹ️ 重要度: 低 (Minor) - 見た目の不整合

### 6. ダークモード時のコントラスト不足
- **現象**: `channels/+page.svelte` でチャンネルのアクセントカラーを `hsl(...)` で計算していますが、明度 (`55%`) が固定されています。
- **影響**: ダークモードの背景色 (`#2f3136`) 上では、特定の `hue` の色が**視認しづらくなる**可能性があります。
- **推奨対策**: CSS変数 (`--bg-primary` 等) に応じて、HSLの明度 (`L`) を調整するロジックを入れるか、CSS `color-mix` 等を活用してください。

### 7. カスタム絵文字のスタイル上書き困難
- **現象**: `post.svelte` でカスタム絵文字に対して `!important` が多用されています。
- **影響**: 将来的に絵文字のサイズを変更したり、特定の場所（リアクションボタン内など）で微調整したい場合に、**CSSの詳細度戦争**が発生し、修正が困難になります。
- **推奨対策**: `!important` を削除し、CSSセレクタの詳細度（特異性）でスタイルを制御するようにリファクタリングしてください。

---

## 対応履歴

### 2026-02-15 実施

| # | 重要度 | 対策 | 対応内容 | ステータス |
|---|--------|------|---------|-----------|
| 1 | Critical | 100vh 問題 | `100vh` に `100dvh` をフォールバック付きで追加。対象: chat-area, sidebar, [channel_id], +layout, new, settings-modal | ✅ 完了 |
| 2 | Critical | Z-index 競合 | `style.scss` に `--z-sidebar`, `--z-sidebar-overlay`, `--z-modal-overlay`, `--z-modal`, `--z-settings-overlay`, `--z-settings-modal`, `--z-upload-overlay` を定義。全コンポーネントで参照に統一 | ✅ 完了 |
| 3 | Major | 長いコンテンツ破壊 | `.post`, `.post-content`, `.post-content p` に `overflow-wrap: anywhere`, `word-break: break-word` を適用 | ✅ 完了 |
| 4 | Major | 画像ギャラリー・プレビュー | `.image-gallery` に `max-height: 280px`。`.image-item` に `aspect-ratio: 1/1`。`.image-preview-container` に `max-height: 140px`, `overflow-x: auto`, `flex-wrap: nowrap` | ✅ 完了 |
| 5 | Major | モバイルキーボード | viewport メタタグに `interactive-widget=resizes-content` を追加 | ✅ 完了 |
| 6 | Minor | ダークモードアクセント | チャンネルアクセントを `--accent-hue` に分離し、ダークモード時は明度 65% に調整 | ✅ 完了 |
| 7 | Minor | カスタム絵文字 !important | `!important` を削除し、`.post-actions .reaction-btn` 等の詳細度で制御 | ✅ 完了 |
