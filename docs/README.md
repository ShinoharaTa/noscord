# Noscord ドキュメント

## 概要

Noscord は **Nostr プロトコルを使ったパブリックなチャンネル型チャットクライアント**です。  
フロントエンドは **SvelteKit + Vite** で構成されています。

この `docs/` は「現状の実装内容」と「これからやりたいこと」を、プロジェクト内の実装に即してまとめたものです。

## アプリの画面（ルーティング）

- **`/`**: ホーム（最近のアクティビティ/チャンネル導線）
- **`/channels`**: 他のチャンネルを探す（外部 API 経由でチャンネル一覧）
- **`/new`**: 新しいチャンネルを作成（チャンネル作成＋最初の投稿）
- **`/[channel_id]`**: チャンネル閲覧・投稿（タイムライン表示、投稿、画像、リプライ）
- **`/develop/design`**: デザインシステム/コンポーネント確認ページ

## 実装済み機能（要点）

### チャンネル閲覧

- **Nostr のチャンネルメッセージ（Kind 42）**を `nosvelte` の `UniqueEventList` で購読し、時系列で表示します。
- **日付でグルーピング**して表示（「今日/昨日/日付」）。
- メッセージは **自動スクロール**（ユーザーのスクロール操作を検知して抑制/再開）。

### 投稿（メッセージ・リプライ）

- 投稿は `kinds.ChannelMessage`（Kind 42）。
- `tags` に `["e", thread, "", "root"]` を必ず付与し、リプライの場合は `["e", reply, "", "reply"]` を追加します。
- **Ctrl+Enter で送信**（空投稿は抑止）。

### 画像投稿

- 外部 URL の画像は **NIP-92 `imeta` タグ**を付け、content に URL を追記します。
- 画像アップロードは **`nostr.build`（`/api/v2/upload/files`）** を利用します。
- 認証には **NIP-98（Authorization: `Nostr <base64(event)>`）** を用いる実装が入っています。
- 現状、アップロード失敗時などに **Base64 を content に直接埋め込む挙動**があります（後述の「改善したい点」参照）。

### 認証・鍵管理

- 秘密鍵を入力/生成してブラウザの `localStorage` に保持します。
  - **nsec1 形式/hex 形式**の入力をサポートし、内部保存は hex。
- **NIP-07（ブラウザ拡張: nos2x 等）**による署名をサポート。
  - `window.nostr.getPublicKey()` / `window.nostr.signEvent()` を利用。
- 設定モーダルから「秘密鍵管理」「NIP-07 接続/解除」が可能です。

### チャンネル作成

- チャンネル作成は **Kind 40（ChannelCreation）** を投げます。
- 作成直後に **最初のメッセージ（Kind 42）**を投稿します。
- チャンネル一覧に反映されるまで時間がかかる可能性がある旨の注記あり。

### リアクション

- **NIP-25 リアクション（Kind 7）**を投稿可能。
- **NIP-09（Kind 5）**でリアクション削除が可能。
- リアクション集計・表示のためのユーティリティ（集計/サニタイズ/カスタム絵文字処理）が実装されています。

### リレー

複数の Nostr relay に publish/subscribe します（`$lib/nostr.ts` 参照）。

### UI/UX

- サイドバー + チャットエリアのレイアウト
- レスポンシブ（モバイルでサイドバーの開閉）
- Service Worker 登録（PWA 方向の下地）

## データ取得の現状（チャンネル一覧）

チャンネル一覧は現状 **外部の REST API** から取得する実装があります。

- `GET https://thread.nchan.vip/channels`
  - 配列または `{ data: [...] }` 形式の両方を受ける前提
  - `events` が無い場合は空配列を補完

このエンドポイントは **このプロジェクトでは固定（変更しない）** とします。  
そのうえで、依存の位置付け（必須/任意）や取得経路の整理は必要です（後述）。

## 「nchan」参照（過去プロジェクト由来）の残骸と置換対象

現状の実装には `nchan` 名義の URL/キー名が残っています。**ドキュメント上は Noscord 名義で記載**し、実装側の残骸は以下を置換候補として扱います。

### localStorage キー

- **現状**:
  - `nchan_keys_v1`
  - `nchan_use_nip07`
  - `nchan_private_key`（削除対象として remove している）
  - `nchan_private_key_expire`（同上）
- **置換案**:
  - `noscord_keys_v1`
  - `noscord_use_nip07`
  - （不要なら完全廃止し migration で掃除）

### 外部 API / アセット URL

- **現状**:
  - チャンネル一覧 API: `https://thread.nchan.vip/channels`（固定・変更しない）
  - チャンネル画像: `https://nchan.shino3.net/channel_img.png`
- **置換案**:
  - チャンネル画像など「変更してよいもの」は、Noscord 用に整理（`.env` 等で環境変数化が望ましい）

## 今後やりたいこと（案）

実装を読む限り、次の方向性が「次に手を入れると効く」候補です（優先順は暫定）。

- **nchan 残骸の整理**: チャンネル一覧 API の URL は固定で維持しつつ、その他（キー名/画像URL等）を整理する
- **チャンネル一覧取得の整理**: REST API 依存の位置付け（必須/任意）を明確化し、取得経路を一本化（URLは固定）
- **画像投稿の設計整理**: Base64 埋め込みの扱いを明確に（容量・互換性・安全性・UX）
- **ログ/デバッグ出力の整理**: console ログの常時出力を制御（必要最小限）
- **エラーハンドリング方針の明文化**: どこまで UI に出すか、再試行の方針、リレー障害時の扱い
- **テストと CI**: `npm run check` / `npm run lint` の自動化、E2E テスト（Playwright）導入済み
- **セキュリティ**: 秘密鍵の取り扱い（保存方式・マスク・誤操作防止・利用者向け注意喚起の整理）

## E2E テスト（Playwright）

`npm run test:e2e` でブラウザを自動実行し、UI 崩れや UX を検証します。

- **対象**: ホーム、チャンネル一覧、新規作成、チャンネルページ、デザイン確認ページ
- **検証内容**: ページ表示、サイドバー・ナビゲーション、レイアウト崩れ（オーバーフロー）、モバイルビューポート、ボタン操作
- **実行環境**: Chromium（デスクトップ）、Mobile Chrome（Pixel 5）

## Tailwind CSS

スタイリングに **Tailwind CSS v4** を導入しています。

- **設定**: `src/styles/app.css` に `@import "tailwindcss"` と `@theme` でデザイントークンをマッピング
- **Vite プラグイン**: `@tailwindcss/vite` を `vite.config.ts` で使用
- **既存デザインシステムとの共存**: `:root` の CSS 変数（ライト/ダークモード）は `style.scss` で維持し、`@theme` から `var()` で参照
- **グローバルスタイル**: `style.scss` の要素リセット（`button`, `input` 等）は `@layer base` に配置し、Tailwind ユーティリティが上書き可能
- **テーマトークン**: `accent`(緑), `foreground`(テキスト), `surface`(背景), `border` 等の意味的な名前で定義

## 開発者向けメモ

- 開発スクリプトは `package.json` の `scripts` を参照（`dev`, `build`, `check`, `lint`, `test:e2e`）。

